var t=require("stimulus"),e=require("jquery-events-to-dom-events"),i=require("lodash");function n(t){var e=(t.match(/^(?:\.\/)?(.+)(?:[_-]controller\..+?)$/)||[])[1];if(e)return e.replace(/_/g,"-").replace(/\//g,"--")}function r(){return r=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var i=arguments[e];for(var n in i)Object.prototype.hasOwnProperty.call(i,n)&&(t[n]=i[n])}return t},r.apply(this,arguments)}function a(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t,o(t,e)}function o(t,e){return o=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t},o(t,e)}var s=function(t){function e(){return t.apply(this,arguments)||this}a(e,t);var i=e.prototype;return i.connect=function(){var t=document.getElementById("hammerstone_refine_query");this.state=this.application.getControllerForElementAndIdentifier(t,"refine--state"),this.blueprintInput=this.addHiddenInput("blueprint"),this.addHiddenInput("filter",this.state.filterName),this.finishUpdate()},i.addHiddenInput=function(t,e){var i=document.createElement("input");return i.type="hidden",i.name=t,i.value=e||"",this.element.appendChild(i),i},i.finishUpdate=function(){this.state.finishUpdate()},i.startUpdate=function(){this.blueprintInput.value=JSON.stringify(this.state.blueprint),this.state.startUpdate()},i.submitForm=function(){this.startUpdate(),this.element.requestSubmit()},e}(t.Controller),l=function(t){function e(){return t.apply(this,arguments)||this}a(e,t);var i=e.prototype;return i.criterion=function(){this.state.addCriterion(this.previousCriterionIdValue),this.startUpdate()},i.group=function(){this.state.addGroup(),this.startUpdate()},e}(s);l.values={previousCriterionId:Number};var u=function(t){function e(){return t.apply(this,arguments)||this}return a(e,t),e.prototype.connect=function(){var t=document.getElementById("refine");this.state=this.application.getControllerForElementAndIdentifier(t,"refine--state"),this.state.updateInput(this.criterionIdValue,this.inputValue)},e}(t.Controller);u.values={criterionId:Number,input:Object};var d=function(t){function e(){return t.apply(this,arguments)||this}return a(e,t),e.prototype.criterion=function(){this.state.deleteCriterion(this.criterionIdValue),this.startUpdate()},e}(s);d.values={criterionId:Number},function(){if("function"==typeof window.CustomEvent)return!1;function t(t,e){e=e||{bubbles:!1,cancelable:!1,detail:void 0};var i=document.createEvent("CustomEvent");return i.initCustomEvent(t,e.bubbles,e.cancelable,e.detail),i}t.prototype=window.Event.prototype,window.CustomEvent=t}();var c=function(t,e,i,n){var r=new CustomEvent("filter-stabilized",{bubbles:!0,cancelable:!0,detail:{stableId:e,filterName:i,initialLoad:n}});t.dispatchEvent(r)},p=function(t){var e=new CustomEvent("filter-unstable",{detail:{blueprint:t}});window.dispatchEvent(e)},h=function(t,e,i){var n=i.meta,r={clause:n.clauses[0].id,selected:"option-condition"===i.component?[n.options[0].id]:void 0};return i.refinements.forEach(function(t){var e=t.meta;r[t.id]={clause:e.clauses[0].id,selected:"option-condition"===t.component?[e.options[0].id]:void 0}}),{depth:e,type:"criterion",condition_id:t,input:r}},f=function(t){function i(){return t.apply(this,arguments)||this}a(i,t);var n=i.prototype;return n.connect=function(){this.changeDelegate=e.delegate("change",["event","picker"]),this.blueprint=this.blueprintValue,this.conditions=this.conditionsValue,this.filterName=this.classNameValue,this.stableId=this.stableIdValue,this.conditionsLookup=this.conditions.reduce(function(t,e){return t[e.id]=e,t},{}),this.loadingTimeout=null,c(this.element,this.stableId,this.filterName,!0),c(window,this.stableId,this.filterName,!0)},n.disconnect=function(){e.abnegate("change",this.changeDelegate)},n.startUpdate=function(){var t=this;this.loadingTimeout&&window.clearTimeout(this.loadingTimeout),this.loadingTimeout=window.setTimeout(function(){document.activeElement.blur(),t.loadingTarget.classList.remove("hidden")},1e3)},n.finishUpdate=function(){this.loadingTimeout&&window.clearTimeout(this.loadingTimeout),this.loadingTarget.classList.add("hidden")},n.conditionConfigFor=function(t){return this.conditionsLookup[t]},n.updateStableId=function(t){t!==this.stableId&&(this.stableId=t,c(this.element,this.stableId,this.filterName),c(window,this.stableId,this.filterName))},n.addGroup=function(){var t,e=this.conditions[0];this.blueprint.length>0&&this.blueprint.push({depth:t=void 0===t?0:t,type:"conjunction",word:"or"}),this.blueprint.push(h(e.id,1,e)),p(this.blueprint)},n.addCriterion=function(t){var e,i=this.conditions[0];this.blueprint.splice(t+1,0,{depth:e=void 0===e?1:e,type:"conjunction",word:"and"},h(i.id,1,i)),p(this.blueprint)},n.deleteCriterion=function(t){var e=this.blueprint,i=e[t-1],n=e[t+1],r=i&&"or"===i.word,a=n&&"or"===n.word||!n,o=r||!i,s=o&&a;if(i||n?e.splice(s&&r?t-1:s&&!i||o&&!a?t:t-1,2):this.blueprint=[],0===this.blueprint.length){var l=this.conditions[0];this.blueprint.push(h(l.id,1,l))}p(this.blueprint)},n.replaceCriterion=function(t,e,i){var n=this.blueprint[t];if("criterion"!==n.type)throw new Error("You can't call updateConditionId on a non-criterion type. Trying to update "+JSON.stringify(h));this.blueprint[t]=h(e,n.depth,i),p(this.blueprint)},n.updateInput=function(t,e,i){var n=this.blueprint[t],a=(i=i||"input").split(", ");a.length>1?n[a[0]][a[1]]=r({},n[a[0]][a[1]],e):n[i]=r({},n[i],e),p(this.blueprint)},i}(t.Controller);f.values={blueprint:Array,conditions:Array,className:String,stableId:String},f.targets=["loading"];var b=function(t){function e(){return t.apply(this,arguments)||this}a(e,t);var i=e.prototype;return i.connect=function(){var t;this.idValue&&(t=new CustomEvent("filter-stored",{detail:{storedFilterId:this.idValue}}),window.dispatchEvent(t))},i.updateStableIdField=function(t){this.hasStableIdFieldTarget&&(this.stableIdFieldTarget.value=t.detail.stableId)},i.activateSaveLink=function(t){var e=t.detail,i=e.stableId,n=e.initialLoad;if(i==this.stableIdValue&&(t.preventDefault(),t.stopPropagation()),this.hasEnabledSaveLinkTarget&&this.hasDisabledSaveLinkTarget&&!n){var r=new URL(this.enabledSaveLinkTarget.href);r.searchParams.set("stable_id",i),this.enabledSaveLinkTarget.setAttribute("href",r),this.disabledSaveLinkTarget.classList.add("hidden"),this.enabledSaveLinkTarget.classList.remove("hidden")}},e}(t.Controller);b.targets=["enabledSaveLink","disabledSaveLink","stableIdField"],b.values={id:Number,stableId:String};var v=function(t){function e(){return t.apply(this,arguments)||this}a(e,t);var n=e.prototype;return n.initialize=function(){var t=this;this.updateBlueprint=i.debounce(function(e,i,n){t.value(e,i,n),t.createStableId(t.state.blueprint,t.state.filterName)},500)},n.connect=function(){s.prototype.connect.apply(this),this.state.updateStableId(this.stableIdValue)},n.refinedFilter=function(t){this.state.updateInput(this.criterionIdValue,{id:t.target.value},t.target.dataset.inputId),this.submitForm()},n.clause=function(t){this.state.updateInput(this.criterionIdValue,{clause:t.target.value},t.target.dataset.inputId),this.submitForm()},n.selected=function(t){var e=Array.prototype.slice.call(t.target.options).filter(function(t){return t.selected}).map(function(t){return t.value});this.value(t,e,"selected"),this.createStableId(this.state.blueprint,this.state.filterName)},n.value=function(t,e,i){var n,r=t.target.dataset,a=r.inputId;this.state.updateInput(this.criterionIdValue,((n={})[i=i||r.inputKey||"value"]=e=e||t.target.value,n),a)},n.date=function(t){var e=t.detail.picker.startDate.format("YYYY-MM-DD");this.value(t,e),this.submitForm()},n.createStableId=function(t,e){var i=this.state,n=JSON.stringify({blueprint:t,filter:e}),r=document.querySelector("meta[name='csrf-token']").content;$.ajax({type:"PUT",url:"/hammerstone/update_stable_id",data:n,headers:{accept:"application/json","content-type":"application/json","X-CSRF-Token":r},success:function(t){i.updateStableId(t.filter_id)}})},n.condition=function(t){var e=this.criterionIdValue,i=this.state,n=t.target.value,r=this.state.conditionConfigFor(n);i.replaceCriterion(e,n,r),this.submitForm()},e}(s);v.values={criterionId:Number,stableId:String};var m=[[l,"refine/add-controller.js"],[u,"refine/defaults-controller.js"],[d,"refine/refine/delete-controller.js"],[s,"refine/refine/form-controller"],[f,"refine/state-controller.js"],[b,"refine/stored-filter-controller.js"],[v,"refine/update-controller.js"]].map(function(t){var e=t[0];return{identifier:n(t[1]),controllerConstructor:e}});exports.AddController=l,exports.DefaultsController=u,exports.DeleteController=d,exports.FormController=s,exports.StateController=f,exports.StoredFilterController=b,exports.UpdateController=v,exports.controllerDefinitions=m;
//# sourceMappingURL=refine-rails.js.map
