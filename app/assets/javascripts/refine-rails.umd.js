!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("stimulus"),require("jquery-events-to-dom-events"),require("lodash")):"function"==typeof define&&define.amd?define(["exports","stimulus","jquery-events-to-dom-events","lodash"],e):e((t||self).refineRails={},t.stimulus,t.jqueryEventsToDomEvents,t.lodash)}(this,function(t,e,i,n){function r(t){var e=(t.match(/^(?:\.\/)?(.+)(?:[_-]controller\..+?)$/)||[])[1];if(e)return e.replace(/_/g,"-").replace(/\//g,"--")}function o(){return o=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var i=arguments[e];for(var n in i)Object.prototype.hasOwnProperty.call(i,n)&&(t[n]=i[n])}return t},o.apply(this,arguments)}function a(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t,s(t,e)}function s(t,e){return s=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t},s(t,e)}var l=function(t){function e(){return t.apply(this,arguments)||this}a(e,t);var i=e.prototype;return i.connect=function(){var t=document.getElementById("hammerstone_refine_query");this.state=this.application.getControllerForElementAndIdentifier(t,"refine--state"),this.blueprintInput=this.addHiddenInput("blueprint"),this.addHiddenInput("filter",this.state.filterName),this.finishUpdate()},i.addHiddenInput=function(t,e){var i=document.createElement("input");return i.type="hidden",i.name=t,i.value=e||"",this.element.appendChild(i),i},i.finishUpdate=function(){this.state.finishUpdate()},i.startUpdate=function(){this.blueprintInput.value=JSON.stringify(this.state.blueprint),this.state.startUpdate()},i.submitForm=function(){this.startUpdate(),this.element.requestSubmit()},e}(e.Controller),u=function(t){function e(){return t.apply(this,arguments)||this}a(e,t);var i=e.prototype;return i.criterion=function(){this.state.addCriterion(this.previousCriterionIdValue),this.startUpdate()},i.group=function(){this.state.addGroup(),this.startUpdate()},e}(l);u.values={previousCriterionId:Number};var d=function(t){function e(){return t.apply(this,arguments)||this}return a(e,t),e.prototype.connect=function(){var t=document.getElementById("refine");this.state=this.application.getControllerForElementAndIdentifier(t,"refine--state"),this.state.updateInput(this.criterionIdValue,this.inputValue)},e}(e.Controller);d.values={criterionId:Number,input:Object};var c=function(t){function e(){return t.apply(this,arguments)||this}return a(e,t),e.prototype.criterion=function(){this.state.deleteCriterion(this.criterionIdValue),this.startUpdate()},e}(l);c.values={criterionId:Number},function(){if("function"==typeof window.CustomEvent)return!1;function t(t,e){e=e||{bubbles:!1,cancelable:!1,detail:void 0};var i=document.createEvent("CustomEvent");return i.initCustomEvent(t,e.bubbles,e.cancelable,e.detail),i}t.prototype=window.Event.prototype,window.CustomEvent=t}();var p=function(t,e,i,n){var r=new CustomEvent("filter-stabilized",{bubbles:!0,cancelable:!0,detail:{stableId:e,filterName:i,initialLoad:n}});t.dispatchEvent(r)},h=function(t){var e=new CustomEvent("filter-unstable",{detail:{blueprint:t}});window.dispatchEvent(e)},f=function(t,e,i){var n=i.meta,r={clause:n.clauses[0].id,selected:"option-condition"===i.component?[n.options[0].id]:void 0};return i.refinements.forEach(function(t){var e=t.meta;r[t.id]={clause:e.clauses[0].id,selected:"option-condition"===t.component?[e.options[0].id]:void 0}}),{depth:e,type:"criterion",condition_id:t,input:r}},b=function(t){function e(){return t.apply(this,arguments)||this}a(e,t);var n=e.prototype;return n.connect=function(){this.changeDelegate=i.delegate("change",["event","picker"]),this.blueprint=this.blueprintValue,this.conditions=this.conditionsValue,this.filterName=this.classNameValue,this.stableId=this.stableIdValue,this.conditionsLookup=this.conditions.reduce(function(t,e){return t[e.id]=e,t},{}),this.loadingTimeout=null,p(this.element,this.stableId,this.filterName,!0),p(window,this.stableId,this.filterName,!0)},n.disconnect=function(){i.abnegate("change",this.changeDelegate)},n.startUpdate=function(){var t=this;this.loadingTimeout&&window.clearTimeout(this.loadingTimeout),this.loadingTimeout=window.setTimeout(function(){document.activeElement.blur(),t.loadingTarget.classList.remove("hidden")},1e3)},n.finishUpdate=function(){this.loadingTimeout&&window.clearTimeout(this.loadingTimeout),this.loadingTarget.classList.add("hidden")},n.conditionConfigFor=function(t){return this.conditionsLookup[t]},n.updateStableId=function(t){t!==this.stableId&&(this.stableId=t,p(this.element,this.stableId,this.filterName),p(window,this.stableId,this.filterName))},n.addGroup=function(){var t,e=this.conditions[0];this.blueprint.length>0&&this.blueprint.push({depth:t=void 0===t?0:t,type:"conjunction",word:"or"}),this.blueprint.push(f(e.id,1,e)),h(this.blueprint)},n.addCriterion=function(t){var e,i=this.conditions[0];this.blueprint.splice(t+1,0,{depth:e=void 0===e?1:e,type:"conjunction",word:"and"},f(i.id,1,i)),h(this.blueprint)},n.deleteCriterion=function(t){var e=this.blueprint,i=e[t-1],n=e[t+1],r=i&&"or"===i.word,o=n&&"or"===n.word||!n,a=r||!i,s=a&&o;if(i||n?e.splice(s&&r?t-1:s&&!i||a&&!o?t:t-1,2):this.blueprint=[],0===this.blueprint.length){var l=this.conditions[0];this.blueprint.push(f(l.id,1,l))}h(this.blueprint)},n.replaceCriterion=function(t,e,i){var n=this.blueprint[t];if("criterion"!==n.type)throw new Error("You can't call updateConditionId on a non-criterion type. Trying to update "+JSON.stringify(f));this.blueprint[t]=f(e,n.depth,i),h(this.blueprint)},n.updateInput=function(t,e,i){var n=this.blueprint[t],r=(i=i||"input").split(", ");r.length>1?n[r[0]][r[1]]=o({},n[r[0]][r[1]],e):n[i]=o({},n[i],e),h(this.blueprint)},e}(e.Controller);b.values={blueprint:Array,conditions:Array,className:String,stableId:String},b.targets=["loading"];var v=function(t){function e(){return t.apply(this,arguments)||this}a(e,t);var i=e.prototype;return i.connect=function(){var t;this.idValue&&(t=new CustomEvent("filter-stored",{detail:{storedFilterId:this.idValue}}),window.dispatchEvent(t))},i.updateStableIdField=function(t){this.hasStableIdFieldTarget&&(this.stableIdFieldTarget.value=t.detail.stableId)},i.activateSaveLink=function(t){var e=t.detail,i=e.stableId,n=e.initialLoad;if(i==this.stableIdValue&&(t.preventDefault(),t.stopPropagation()),this.hasEnabledSaveLinkTarget&&this.hasDisabledSaveLinkTarget&&!n){var r=new URL(this.enabledSaveLinkTarget.href);r.searchParams.set("stable_id",i),this.enabledSaveLinkTarget.setAttribute("href",r),this.disabledSaveLinkTarget.classList.add("hidden"),this.enabledSaveLinkTarget.classList.remove("hidden")}},e}(e.Controller);v.targets=["enabledSaveLink","disabledSaveLink","stableIdField"],v.values={id:Number,stableId:String};var m=function(t){function e(){return t.apply(this,arguments)||this}a(e,t);var i=e.prototype;return i.initialize=function(){var t=this;this.updateBlueprint=n.debounce(function(e,i,n){t.value(e,i,n),t.createStableId(t.state.blueprint,t.state.filterName)},500)},i.connect=function(){l.prototype.connect.apply(this),this.state.updateStableId(this.stableIdValue)},i.refinedFilter=function(t){this.state.updateInput(this.criterionIdValue,{id:t.target.value},t.target.dataset.inputId),this.submitForm()},i.clause=function(t){this.state.updateInput(this.criterionIdValue,{clause:t.target.value},t.target.dataset.inputId),this.submitForm()},i.selected=function(t){var e=Array.prototype.slice.call(t.target.options).filter(function(t){return t.selected}).map(function(t){return t.value});this.value(t,e,"selected"),this.createStableId(this.state.blueprint,this.state.filterName)},i.value=function(t,e,i){var n,r=t.target.dataset,o=r.inputId;this.state.updateInput(this.criterionIdValue,((n={})[i=i||r.inputKey||"value"]=e=e||t.target.value,n),o)},i.date=function(t){var e=t.detail.picker.startDate.format("YYYY-MM-DD");this.value(t,e),this.submitForm()},i.createStableId=function(t,e){var i=this.state,n=JSON.stringify({blueprint:t,filter:e}),r=document.querySelector("meta[name='csrf-token']").content;$.ajax({type:"PUT",url:"/hammerstone/update_stable_id",data:n,headers:{accept:"application/json","content-type":"application/json","X-CSRF-Token":r},success:function(t){i.updateStableId(t.filter_id)}})},i.condition=function(t){var e=this.criterionIdValue,i=this.state,n=t.target.value,r=this.state.conditionConfigFor(n);i.replaceCriterion(e,n,r),this.submitForm()},e}(l);m.values={criterionId:Number,stableId:String};var g=[[u,"refine/add-controller.js"],[d,"refine/defaults-controller.js"],[c,"refine/refine/delete-controller.js"],[l,"refine/refine/form-controller"],[b,"refine/state-controller.js"],[v,"refine/stored-filter-controller.js"],[m,"refine/update-controller.js"]].map(function(t){var e=t[0];return{identifier:r(t[1]),controllerConstructor:e}});t.AddController=u,t.DefaultsController=d,t.DeleteController=c,t.FormController=l,t.StateController=b,t.StoredFilterController=v,t.UpdateController=m,t.controllerDefinitions=g});
//# sourceMappingURL=refine-rails.umd.js.map
